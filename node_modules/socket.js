var express = require('express');
var http = require('http');
var Redis = require('ioredis');
var mysql = require('mysql');

var app = express();
var srv = http.Server(app);
var io = require('socket.io')(srv);
var redis = new Redis();

var conn = mysql.createConnection({
    host: 'http://ec2-54-213-119-114.us-west-2.compute.amazonaws.com/',
    user: 'root',
    password: 'kiki8621',
    database:'chatroom',
    socketPath:'/var/run/mysqld/mysqld.sock',
    port: 3306
});

var selectSQL = 'select channel_name from channels';

//conn.connect();
conn.query(selectSQL, function(err, rows, fields) {
	var chs=[];
    if (err) throw err;
    for(var i in rows){

    	
    	//console.log('The channels are: ', rows[i].channel_name);
    	chs.push( rows[i].channel_name)
    }
    var ret = redis.subscribe(chs, function (err, count) {
			console.log('erro msg:'+err+"\n");
		});
});
//conn.end();



redis.subscribe('controller-channel', function (err, count) {
			console.log('erro msg:'+err+"\n");
		});



// $.get('chat/',function(data){
// 	console.log(data);
// });

redis.on('message',function(channel,message){
	message = JSON.parse(message);
	
	var cmd = message.data['command'];
	
	//Admin operation
	//console.log(message.data['command']);
	if(cmd=='create'){
		//console.log('test1');
		redis.subscribe(message.data['channelname'], function (err, count) {
			if(err){
				console.log('erro msg:'+err+"\n");
			}
				
		});

		//message.data['result'] = 'Done';
		io.emit('controller-channel'+":"+message.event,message.data);
		console.log("msg content:"+JSON.stringify(message.data));
	}
	else{
		//User operation
		io.emit(channel+":"+message.event,message.data);
		console.log("msg content:"+JSON.stringify(message.data));
	}
	
});

srv.listen(3000,function(){
	console.log('listening on port 3000')
});
