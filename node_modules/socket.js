var express = require('express');
var http = require('http');
var Redis = require('ioredis');
var mysql = require('mysql');

var app = express();
var srv = http.Server(app);
var io = require('socket.io')(srv);
var redis = new Redis();

var conn = mysql.createConnection({
    host: 'localhost',
    user: 'root',
    password: '',
    database:'chatroom',
    socketPath:'/Applications/XAMPP/xamppfiles/var/mysql/mysql.sock',
    port: 3306
});

var selectSQL = 'select channel_name from channels';

//conn.connect();
conn.query(selectSQL, function(err, rows, fields) {
	var chs=[];
    if (err) throw err;
    for(var i in rows){

    	
    	//console.log('The channels are: ', rows[i].channel_name);
    	chs.push( rows[i].channel_name)
    }
    var ret = redis.subscribe(chs, function (err, count) {
			console.log('erro msg:'+err+"\n");
		});
});
//conn.end();







// $.get('chat/',function(data){
// 	console.log(data);
// });

redis.on('message',function(channel,message){
	message = JSON.parse(message);
	io.emit(channel+":"+message.event,message.data);
	console.log("msg content:"+JSON.stringify(message.data));
});

srv.listen(3000,function(){
	console.log('listening on port 3000')
});